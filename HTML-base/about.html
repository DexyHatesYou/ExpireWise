<!DOCTYPE html>
<html>
<head>
	<style>
		@font-face { font-family: g; src: url('hwyuenei64.ttf'); }
			

			.g{
				font-family: g;
			}

			body {
      background-color: #BFCBCE;
      overflow: hidden;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      background: rgb(86,91,117);
      background: linear-gradient(180deg, rgba(86,91,117,1) 0%, rgba(191,203,206,1) 12%);
    }

    .load{
      animation: load 0.6s ease-in forwards;
    }

    @keyframes load {
      from { opacity: 0%; }
      to { opacity: 100% } 
    }

    .a{
      position: relative;
      align-items: center;
      align-self: center;
      text-align: center;
      width: 100%;
      top: -10%;
    }

        #date {
      color: white;
      position: absolute;
      top: 1%;
      left: 6%;
      font-size: 130%;
    }

.body {
  width: 100%;
  height: 100%;
  display: flex;
        justify-content: center;
      align-items: center;
               opacity: 0;
   transition: load 0.6s;
}

.text{
  width: 90%;
  position: absolute;
  left: 5%;
}


img {
   width: 20%;
    position: absolute;
    top: -25%;
    left: 40%;
    transition: top 1.8s;
}

img.animate {
    top: 110%;
}

	</style>
	<meta charset="utf-8">
  <script src="https://kit.fontawesome.com/2fd69ec569.js" crossorigin="anonymous"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ExpireWise</title>
</head>
<body>
<p id="date" class="g"></p>
<g class="body load">

<div class="a">
<h1 class="g" id="a1">Lorem Ipsum</h1><br>
<p class="g text">Creating this app was a challenging yet rewarding journey. While it may not be perfect, it works reliably and achieves its purpose. This project wouldn't have been possible without some <t onclick="egg()";>valuable help</t> and a lot of determination!</p>
</div>

<button id="testALG">TEST DA ALG</button>

</g>

<img src="https://img.icons8.com/ios/500/565b75/marijuana-leaf.png" alt="marijuana-leaf"/>

<script src="date.js"></script>
</body>
<script>

const img = document.querySelector('img');

  window.transitionToPage = function(href) {
    document.querySelector('.body').style.opacity = 0
    setTimeout(function() { 
        window.location.href = href
    }, 500)
}

function egg() {
    const img = document.querySelector('img');
    img.classList.add('animate');
    
    setTimeout(() => {
        img.classList.remove('animate');
        img.style.top = '-25%';

    }, 1800);
}


document.getElementById('testALG').addEventListener('click', async () => {
  try {
    console.clear();
    console.log('▶️ Starting algorithm debug run');

    const spId = localStorage.getItem('spId');
    console.log('spId from localStorage:', spId);
    if (!spId) throw new Error('No session in localStorage');

    // Single fetch
    console.log('Fetching combined data from getData.php …');
    const resp = await fetch('https://expirewise.localto.net/api/getData.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ spId })
    });
    const data = await resp.json();
    console.log('📥 RAW PAYLOAD:', data);

    if (data.status !== 'ok') {
      console.error('❌ Server returned:', data);
      return;
    }

    const { ingredients, recipes } = data;
    console.log(`Fetched ${ingredients.length} ingredients and ${recipes.length} recipes`);

    // Build daysToExpiry map
    const now = Date.now();
    const daysToExpiry = {};
    ingredients.forEach(i => {
      const msDiff = new Date(i.expiration_date) - now;
      const days = msDiff > 0 ? msDiff / (1000*60*60*24) : 0;
      daysToExpiry[i.ingredient_id] = days;
      console.log(
        `Ingredient ${i.ingredient_id}: expiration_date=${i.expiration_date}, ` +
        `daysToExpiry=${days.toFixed(2)}`
      );
    });
    console.log('🏷 daysToExpiry map:', daysToExpiry);

    // Score each recipe
    const w1 = 0.7, w2 = 0.3;
    const debugResults = [];
    recipes.forEach(r => {
      console.group(`Recipe ${r.recipe_id} — ${r.name}`);
      const available = [];
      const missing = [];
      (r.ingredients || []).forEach(id => {
        if (id in daysToExpiry) {
          available.push(id);
        } else {
          missing.push(id);
        }
      });
      console.log(' Available IDs:', available);
      console.log(' Missing IDs:  ', missing);

      const expiryScore = available.length
        ? Math.min(...available.map(id => daysToExpiry[id]))
        : Infinity;
      console.log(' Computed expiryScore:', expiryScore === Infinity ? '∞' : expiryScore.toFixed(2));

      const missingCount = missing.length;
      console.log(' Missing count:', missingCount);

      const score = w1 * (1 / (expiryScore + 1e-4))
                  + w2 * (1 / (missingCount + 1));
      console.log(' Final score:', score.toFixed(4));

      console.groupEnd();

      debugResults.push({
        recipe_id:   r.recipe_id,
        name:        r.name,
        available,
        missing,
        expiryScore: expiryScore === Infinity ? null : Number(expiryScore.toFixed(2)),
        missingCount,
        score:       Number(score.toFixed(4))
      });
    });

    // Sort descending and show top 10
    debugResults.sort((a, b) => b.score - a.score);
    console.log('✅ Top 10 recipes by score:');
    console.table(debugResults.slice(0, 10));

  } catch (err) {
    console.error('Algorithm error:', err);
  }
});


</script>
</html>