<!DOCTYPE html>
<html>
<head>
	<style>
		@font-face { font-family: g; src: url('hwyuenei64.ttf'); }
			

			.g{
				font-family: g;
			}

			body {
      background-color: #BFCBCE;
      overflow: hidden;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      background: rgb(86,91,117);
      background: linear-gradient(180deg, rgba(86,91,117,1) 0%, rgba(191,203,206,1) 12%);
    }

    .load{
      animation: load 0.6s ease-in forwards;
    }

    @keyframes load {
      from { opacity: 0%; }
      to { opacity: 100% } 
    }

    .a{
      position: relative;
      align-items: center;
      align-self: center;
      text-align: center;
      width: 100%;
      top: -10%;
    }

        #date {
      color: white;
      position: absolute;
      top: 1%;
      left: 6%;
      font-size: 130%;
    }

.body {
  width: 100%;
  height: 100%;
  display: flex;
        justify-content: center;
      align-items: center;
               opacity: 0;
   transition: load 0.6s;
}

.text{
  width: 90%;
  position: absolute;
  left: 5%;
}


img {
   width: 20%;
    position: absolute;
    top: -25%;
    left: 40%;
    transition: top 1.8s;
}

img.animate {
    top: 110%;
}

	</style>
	<meta charset="utf-8">
  <script src="https://kit.fontawesome.com/2fd69ec569.js" crossorigin="anonymous"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ExpireWise</title>
</head>
<body>
<p id="date" class="g"></p>
<g class="body load">

<div class="a">
<h1 class="g" id="a1">Lorem Ipsum</h1><br>
<p class="g text">Creating this app was a challenging yet rewarding journey. While it may not be perfect, it works reliably and achieves its purpose. This project wouldn't have been possible without some <t onclick="egg()";>valuable help</t> and a lot of determination!</p>
</div>

<button id="testALG">TEST DA ALG</button>

</g>

<img src="https://img.icons8.com/ios/500/565b75/marijuana-leaf.png" alt="marijuana-leaf"/>

<script src="date.js"></script>
</body>
<script>

const img = document.querySelector('img');

  window.transitionToPage = function(href) {
    document.querySelector('.body').style.opacity = 0
    setTimeout(function() { 
        window.location.href = href
    }, 500)
}

function egg() {
    const img = document.querySelector('img');
    img.classList.add('animate');
    
    setTimeout(() => {
        img.classList.remove('animate');
        img.style.top = '-25%';

    }, 1800);
}


document.getElementById('testALG').addEventListener('click', async () => {
  try {
    // 1) Resolve session -> userId
    const spId = localStorage.getItem('spId');
    if (!spId) throw new Error('No session ID found in localStorage.');

    const userResp = await fetch('https://expirewise.localto.net/api/getUser.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ spId })
    });
    const userData = await userResp.json();
    if (userData.status !== 'Found') {
      console.error('User session not found.');
      return;
    }
    const userId = userData.userId;

    // 2) Fetch user ingredients
    const ingrResp = await fetch('https://expirewise.localto.net/api/getIngredients.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    const ingredients = await ingrResp.json();
    // Map ingredientId -> daysToExpiry
    const now = Date.now();
    const daysToExpiryMap = {};
    ingredients.forEach(item => {
      const diffMs = new Date(item.expirationDate) - now;
      daysToExpiryMap[item.ingredientId] = diffMs > 0
        ? diffMs / (1000 * 60 * 60 * 24)
        : 0;
    });

    // 3) Fetch all recipes
    const recResp = await fetch('https://expirewise.localto.net/api/getRecipes.php');
    const recipes = await recResp.json();

    // 4) For each recipe, get its ingredients and compute score
    const w1 = 0.7;  // weight for expiry
    const w2 = 0.3;  // weight for missing count
    const scoringPromises = recipes.map(async recipe => {
      // fetch its ingredient IDs
      const riResp = await fetch('https://expirewise.localto.net/api/getRecipeIngredients.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ recipeId: recipe.recipeId })
      });
      const reqIngs = await riResp.json();
      const ids = reqIngs.map(r => r.ingredientId);

      // split available vs missing
      const available = [];
      const missing = [];
      ids.forEach(id => {
        if (id in daysToExpiryMap) available.push(id);
        else missing.push(id);
      });

      // compute expiry_score
      let expiryScore;
      if (available.length > 0) {
        // use MIN daysToExpiry (sooner-expiring drives priority)
        expiryScore = Math.min(...available.map(id => daysToExpiryMap[id]));
      } else {
        expiryScore = Infinity; 
      }

      const missingCount = missing.length;
      const score = w1 * (1 / (expiryScore + 0.0001))  // avoid div-zero
                   + w2 * (1 / (missingCount + 1));

      return {
        recipeId:    recipe.recipeId,
        name:        recipe.name,
        missing:     missingCount,
        expiryScore,
        score
      };
    });

    const scored = await Promise.all(scoringPromises);

    // 5) Sort and output top suggestions
    scored.sort((a, b) => b.score - a.score);
    console.table(scored.slice(0, 10));
    // or render into your UI instead of console.table

  } catch (err) {
    console.error('Algorithm error:', err);
  }
});

</script>
</html>